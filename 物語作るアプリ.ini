import os
import random
import re
import requests
import streamlit as st

# =============================
# Helpers
# =============================
def parse_bullets(raw: str) -> list[str]:
    raw = raw.strip()
    if not raw:
        return []
    parts = []
    for line in raw.splitlines():
        line = line.strip()
        if not line:
            continue
        line = re.sub(r"^[\-\*\u2022ãƒ»\d\.\)\(]+\s*", "", line)
        sub = re.split(r"[,\u3001\uFF0C/]", line)  # , ã€ ï¼Œ /
        parts.extend([s.strip() for s in sub if s.strip()])
    seen = set()
    out = []
    for p in parts:
        if p not in seen:
            seen.add(p)
            out.append(p)
    return out

def clamp(n, lo, hi):
    return max(lo, min(hi, n))

def pick_or_custom(choice: str, options: list[str]) -> str:
    if choice == "ãƒ©ãƒ³ãƒ€ãƒ ":
        return random.choice(options)
    return choice

# =============================
# UI Theme (Fantasy / Otome-ish)
# =============================
FANTASY_CSS = """
<style>
/* Background */
.stApp {
  background: radial-gradient(1200px 800px at 20% 10%, rgba(255, 220, 245, 0.55), transparent 60%),
              radial-gradient(900px 700px at 80% 25%, rgba(210, 235, 255, 0.55), transparent 60%),
              radial-gradient(1000px 800px at 50% 90%, rgba(235, 255, 225, 0.45), transparent 60%),
              linear-gradient(135deg, rgba(255,255,255,0.85), rgba(255,255,255,0.65));
}

/* Main container feel */
.block-container {
  padding-top: 2.0rem;
  padding-bottom: 2.5rem;
  max-width: 920px;
}

/* Headings */
h1, h2, h3 {
  letter-spacing: 0.3px;
}

/* Cards */
div[data-testid="stExpander"] {
  border: 1px solid rgba(170, 120, 170, 0.25);
  border-radius: 16px;
  background: rgba(255,255,255,0.72);
  box-shadow: 0 10px 30px rgba(120, 80, 120, 0.08);
}

/* Buttons */
.stButton>button {
  border-radius: 999px;
  border: 1px solid rgba(160, 90, 160, 0.25);
  background: linear-gradient(135deg, rgba(255, 204, 238, 0.95), rgba(210, 236, 255, 0.95));
  color: #2a1630;
  font-weight: 600;
  padding: 0.6rem 1.1rem;
  box-shadow: 0 10px 25px rgba(120, 80, 120, 0.12);
}
.stButton>button:hover{
  transform: translateY(-1px);
  box-shadow: 0 14px 30px rgba(120, 80, 120, 0.16);
}

/* Inputs */
textarea, input, .stTextInput input {
  border-radius: 14px !important;
}

/* Sidebar */
section[data-testid="stSidebar"] {
  background: linear-gradient(180deg, rgba(255, 248, 253, 0.85), rgba(245, 252, 255, 0.85));
  border-right: 1px solid rgba(160, 90, 160, 0.12);
}

/* Soft sparkle header bar */
.fantasy-banner {
  border-radius: 18px;
  padding: 14px 16px;
  background: linear-gradient(135deg, rgba(255, 214, 243, 0.75), rgba(208, 235, 255, 0.75));
  border: 1px solid rgba(160, 90, 160, 0.15);
  box-shadow: 0 12px 30px rgba(120, 80, 120, 0.10);
}
.fantasy-sub {
  opacity: 0.85;
  margin-top: 4px;
}
.small-pill {
  display:inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.72);
  border: 1px solid rgba(160, 90, 160, 0.14);
  margin-right: 8px;
  margin-top: 6px;
  font-size: 0.85rem;
}
</style>
"""

# =============================
# Template Generator (No LLM)
# =============================
def generate_story_template(
    bullets: list[str],
    exaggeration: int,
    tone: str,
    emotional_palette: list[str],
    emotional_wave: int,
    era: str,
    region: str,
    pov: str,
    story_type: str,
    seed: int | None = None,
) -> str:
    if seed is not None:
        random.seed(seed)

    ex = clamp(exaggeration, 0, 10)
    wave = clamp(emotional_wave, 0, 10)

    # Fantasy / Otome flavor words
    motifs = ["æœˆå…‰", "ç¡å­", "è–”è–‡", "éˆ´è˜­", "éŠ€ã®éµ", "æ˜Ÿå±‘", "è–„ç¾½", "é¦™æ°´", "ç§˜å¯†ã®å›å»Š", "å¤æ›¸", "é­”æ³•é™£", "ã‚„ã‚ã‚‰ã‹ãªç‚"]
    sensory = ["ç”˜ã„", "æ·¡ã„", "ã²ãã‚„ã‹ãª", "çœ©ã—ã„", "å„šã„", "ã‚„ã•ãã‚ŒãŸ", "åˆ‡ãªã„", "å‡›ã¨ã—ãŸ"]
    sparkle = ["ãã‚‰ã‚ã", "å…‰ã®ç²’", "å°ã•ãªå¥‡è·¡", "é™ã‹ãªé­”æ³•", "èƒ¸ã®å¥¥ã®éˆ´"]

    # POV
    if pov == "ä¸€äººç§°ï¼ˆæ€§åˆ¥ä¸å•ï¼‰":
        protagonist = random.choice(["ç§", "åƒ•", "ã‚ªãƒ¬"])
    elif pov == "äºŒäººç§°ï¼ˆã‚ãªãŸï¼‰":
        protagonist = "ã‚ãªãŸ"
    else:
        protagonist = random.choice(["å½¼", "å½¼å¥³", "ãã®äºº", "æ—…äºº", "å°‘å¹´", "å°‘å¥³"])

    # Emotion weaving
    emotions = emotional_palette[:] if emotional_palette else ["å¬‰ã—ã„", "åˆ‡ãªã„"]
    if wave >= 7:
        beat = ["é«˜æš", "è½ä¸‹", "æ•‘ã„", "ä½™éŸ»"]
    elif wave >= 4:
        beat = ["æ³¢", "é™°ã‚Š", "ç¯ã‚Š"]
    else:
        beat = ["é™ã‘ã•", "å°ã•ãªæºã‚Œ"]

    # Scene material
    scenes = bullets[:] if bullets else ["æœ", "ã‚³ãƒ¼ãƒ’ãƒ¼", "äºŒåº¦å¯"]

    scale_words = [
        "ã¡ã‚‡ã£ã¨", "å°‘ã—", "ã¾ã‚ã¾ã‚", "ã‚ã‚Šã¨", "ã‘ã£ã“ã†", "ã ã„ã¶", "ã‹ãªã‚Š", "ç›¸å½“", "ã‚ã¡ã‚ƒãã¡ã‚ƒ", "ä¸–ç•ŒãŒåè»¢ã™ã‚‹ãã‚‰ã„"
    ]
    scale = scale_words[clamp(ex, 0, 9)]

    # Build paragraphs
    hook = (
        f"{era}ã®{region}ã€‚{protagonist}ã¯{random.choice(motifs)}ã¿ãŸã„ãªæ°—é…ã®ä¸­ã§ã€"
        f"ã€Œ{scenes[0]}ã€ã‹ã‚‰å§‹ã¾ã‚‹ä¸€æ—¥ã‚’{scale}æŒã¦ä½™ã—ã¦ã„ãŸã€‚"
    )

    # Middle: ensure all bullets appear at least once
    mid_lines = []
    for i, s in enumerate(scenes):
        if i == 0:
            continue
        emotion = random.choice(emotions)
        garnish = random.choice(motifs + sparkle + sensory)
        if story_type == "æ‹":
            action = random.choice(["è¦–ç·šãŒçµ¡ã‚“ã ", "æ‰‹ãŒè§¦ã‚Œãã†ã«ãªã£ãŸ", "è¨€è‘‰ãŒå–‰ã§ã»ã©ã‘ãŸ", "åå‰ã ã‘ãŒæ®‹ã£ãŸ"])
        elif story_type == "å†’é™º":
            action = random.choice(["åœ°å›³ãŒéœ‡ãˆãŸ", "æ‰‰ãŒé–‹ã„ãŸ", "è¶³éŸ³ãŒå¢—ãˆãŸ", "é¢¨å‘ããŒå¤‰ã‚ã£ãŸ"])
        elif story_type == "å–ªå¤±":
            action = random.choice(["ç©ºç™½ãŒå¢—ãˆãŸ", "å½±ãŒä¼¸ã³ãŸ", "è¿”äº‹ãŒæ¥ãªã‹ã£ãŸ", "æ€ã„å‡ºãŒåˆºã•ã£ãŸ"])
        elif story_type == "å†ç”Ÿ":
            action = random.choice(["å‘¼å¸ãŒæˆ»ã£ãŸ", "èƒŒç­‹ãŒä¼¸ã³ãŸ", "æœãŒã‚„ã‚Šç›´ã›ãŸ", "å°ã•ãç¬‘ãˆãŸ"])
        elif story_type == "å‡ºä¼šã„ã¨åˆ¥ã‚Œ":
            action = random.choice(["å‡ºä¼šã£ãŸ", "è¦‹é€ã£ãŸ", "ã™ã‚Œé•ã£ãŸ", "ç½®ã„ã¦ããŸ"])
        else:  # æ—¥å¸¸
            action = random.choice(["æ¹¯æ°—ãŒç«‹ã£ãŸ", "é´ç´ã‚’çµã³ç›´ã—ãŸ", "æ™‚è¨ˆã‚’è¦‹ãŸ", "çª“ã‚’é–‹ã‘ãŸ"])

        ex_phrase = ""
        if ex >= 7:
            ex_phrase = random.choice([
                "é‹å‘½ãŒã‚ã–ã¨ã‚‰ã—ãå’³æ‰•ã„ã—ãŸã¿ãŸã„ã«ã€‚",
                "ç‰©èªã®ç¥æ§˜ãŒãƒšãƒ¼ã‚¸ã‚’ã‚ãã£ãŸã¿ãŸã„ã«ã€‚",
                "å¿ƒãŒå‹æ‰‹ã«BGMã‚’ã¤ã‘ãŸã¿ãŸã„ã«ã€‚"
            ])
        elif ex >= 4:
            ex_phrase = random.choice(["å°‘ã—è„šè‰²ã™ã‚‹ã¨ã€‚", "ç››ã£ã¦è¨€ã†ã¨ã€‚", "è©©çš„ã«è¨€ã†ã¨ã€‚"])
        else:
            ex_phrase = ""

        mid_lines.append(f"ã€Œ{s}ã€ã€‚{protagonist}ã®ä¸­ã§{emotion}ãŒæºã‚Œã¦ã€{action}ã€‚{ex_phrase}ï¼ˆ{garnish}ï¼‰".strip())

    # Emotional turn & ending
    if wave >= 7:
        turn = random.choice([
            f"ã§ã‚‚æ¬¡ã®ç¬é–“ã€{random.choice(motifs)}ã¿ãŸã„ãªä¸å®‰ãŒå·®ã—è¾¼ã‚“ã ã€‚",
            f"å¬‰ã—ã•ã®è£ã«ã€{random.choice(sensory)}ç—›ã¿ãŒéš ã‚Œã¦ã„ãŸã€‚",
            f"ç¬‘ã£ãŸã¯ãšãªã®ã«ã€èƒ¸ã®å¥¥ã§{random.choice(sparkle)}ãŒæ³£ã„ãŸã€‚"
        ])
        ending = random.choice([
            f"{protagonist}ã¯ãã‚Œã§ã‚‚æ­©ã„ãŸã€‚ä»Šæ—¥ã®çµ‚ã‚ã‚Šã«ã€ã‚„ã•ã—ã„{random.choice(sparkle)}ãŒæ®‹ã‚‹ã¨ä¿¡ã˜ã¦ã€‚",
            f"{protagonist}ã¯ä¸€åº¦ã ã‘ç«‹ã¡æ­¢ã¾ã‚Šã€ãã—ã¦é¸ã‚“ã ã€‚åˆ‡ãªã•ã”ã¨æŠ±ãˆã¦é€²ã‚€ã£ã¦ã€‚",
            f"{protagonist}ã¯å°ã•ãæ¯ã‚’åã„ãŸã€‚æ‚ªã„æ—¥ã«ã‚‚ã€æ¬¡ã®é ã¯ã‚ã‚‹ã€‚"
        ])
    elif wave >= 4:
        turn = random.choice([
            f"å°‘ã—ã ã‘ã€å¿ƒã®å¤©æ°—ãŒå¤‰ã‚ã£ãŸã€‚",
            f"å¤§ä¸ˆå¤«ã˜ã‚ƒãªã„ã®ã«ã€å¤§ä¸ˆå¤«ãªãµã‚ŠãŒä¸Šæ‰‹ããªã£ãŸã€‚",
            f"è¨€ãˆãªã‹ã£ãŸè¨€è‘‰ãŒã€å¤œã«æµ®ã„ãŸã€‚"
        ])
        ending = random.choice([
            f"{protagonist}ã¯æ˜æ—¥ã¸ã€{random.choice(sparkle)}ã‚’ã²ã¨ã¤æŒã¡å¸°ã£ãŸã€‚",
            f"{protagonist}ã¯ä»Šæ—¥ã®è‡ªåˆ†ã‚’ã€ã¡ã‚‡ã£ã¨ã ã‘è¨±ã—ãŸã€‚",
            f"{protagonist}ã¯é™ã‹ã«ç¬‘ã£ãŸã€‚ãã‚ŒãŒæ•‘ã„ã«ãªã‚‹æ—¥ã‚‚ã‚ã‚‹ã€‚"
        ])
    else:
        turn = random.choice([
            f"å¤§äº‹ä»¶ã¯èµ·ããªã„ã€‚ãŸã ã€{random.choice(motifs)}ã¿ãŸã„ãªä½™éŸ»ãŒæ®‹ã‚‹ã€‚",
            f"å¿ƒã¯é™ã‹ã§ã€ã§ã‚‚ç¢ºã‹ã«å‹•ã„ã¦ã„ãŸã€‚",
            f"ã²ã¨ã¤ã®å°ã•ãªé¸æŠãŒã€ä»Šæ—¥ã‚’æ•´ãˆãŸã€‚"
        ])
        ending = random.choice([
            f"{protagonist}ã¯ãã£ã¨ç¯ã‚Šã‚’æ¶ˆã—ãŸã€‚æ˜æ—¥ã‚‚ç¶šãã€‚",
            f"{protagonist}ã¯ã‚³ãƒ¼ãƒ’ãƒ¼ã®æ®‹ã‚Šé¦™ã¿ãŸã„ãªå®‰å¿ƒã«åŒ…ã¾ã‚ŒãŸã€‚",
            f"{protagonist}ã¯é™ã‹ã«ç›®ã‚’é–‰ã˜ãŸã€‚ã‚„ã•ã—ã„çµ‚ã‚ã‚Šã€‚"
        ])

    return "\n".join([hook] + mid_lines + [turn, ending]).strip()

# =============================
# Ollama Generator (Optional)
# =============================
def generate_story_ollama(
    bullets: list[str],
    exaggeration: int,
    tone: str,
    emotional_palette: list[str],
    emotional_wave: int,
    era: str,
    region: str,
    pov: str,
    story_type: str,
    num_stories: int,
    model: str,
    endpoint: str,
    timeout_sec: int = 120,
) -> list[str]:
    ex = clamp(exaggeration, 0, 10)
    wave = clamp(emotional_wave, 0, 10)

    bullet_text = "\n".join([f"- {b}" for b in bullets]) if bullets else "- ï¼ˆæœªå…¥åŠ›ï¼‰"
    emo_text = " / ".join(emotional_palette) if emotional_palette else "ï¼ˆæŒ‡å®šãªã—ï¼‰"

    # Style guide (fantasy + otome)
    fantasy_style = (
        "ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã§ã‚ªãƒˆãƒ¡ãƒ†ã‚£ãƒƒã‚¯ã€‚æ·¡ã„æ¯”å–©ï¼ˆèŠ±ãƒ»æœˆå…‰ãƒ»ç¡å­ãƒ»é¦™ã‚Šãƒ»æ˜Ÿå±‘ï¼‰ã‚’é©åº¦ã«ä½¿ã†ã€‚"
        "èª¬æ˜å£èª¿ã ã‘ã«ã›ãšã€æƒ…æ™¯ã¨æ„Ÿæƒ…ãŒå‹•ãç‰©èªã«ã™ã‚‹ã€‚"
    )

    tone_guide = {
        "ã»ã®ã¼ã®": "ã‚„ã•ã—ãæ¸©åº¦ã®ã‚ã‚‹æ–‡ä½“ã€‚æ•‘ã„ã¨å°ã•ãªå¹¸ç¦ã‚’æ®‹ã™ã€‚",
        "ã‚·ãƒªã‚¢ã‚¹": "é™ã‹ãªç·Šå¼µæ„Ÿã€‚å†…é¢ã‚’æ·±ãæ˜ã‚‹ã€‚çµæœ«ã¯å¸Œæœ›ã§ã‚‚è‹¦å‘³ã§ã‚‚å¯ã€‚",
        "ã‚³ãƒ¡ãƒ‡ã‚£": "ãƒ†ãƒ³ãƒè‰¯ãã€è»½ã„ãƒ„ãƒƒã‚³ãƒŸã‚’æ··ãœã‚‹ã€‚ãŸã ã—é›°å›²æ°—ã¯å´©ã—ã™ããªã„ã€‚",
    }.get(tone, "è‡ªç„¶ãªæ—¥æœ¬èªã€‚")

    pov_guide = {
        "ä¸€äººç§°ï¼ˆæ€§åˆ¥ä¸å•ï¼‰": "ä¸€äººç§°ã§æ›¸ãã€‚æ€§åˆ¥ã®å›ºå®šã«ã¤ãªãŒã‚‹æå†™ã¯é¿ã‘ã‚‹ã€‚",
        "ä¸‰äººç§°ï¼ˆæ€§åˆ¥ä¸å•ï¼‰": "ä¸‰äººç§°ã§æ›¸ãã€‚æ€§åˆ¥ã®å›ºå®šã«ã¤ãªãŒã‚‹æå†™ã¯é¿ã‘ã‚‹ã€‚",
        "äºŒäººç§°ï¼ˆã‚ãªãŸï¼‰": "äºŒäººç§°ã§æ›¸ãï¼ˆã‚ãªãŸè¦–ç‚¹ï¼‰ã€‚",
        "ãƒ©ãƒ³ãƒ€ãƒ ": "ä¸€äººç§°ã¾ãŸã¯ä¸‰äººç§°ã€ã¾ãŸã¯äºŒäººç§°ã§è‡ªç”±ã«ã€‚",
    }.get(pov, "è¦–ç‚¹ã¯è‡ªç”±ã€‚")

    prompt = f"""
ã‚ãªãŸã¯ç‰©èªä½œå®¶ã§ã™ã€‚ç®‡æ¡æ›¸ãã®ç´ æã‹ã‚‰ã€çŸ­ã„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’{num_stories}æœ¬ã€æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

å¿…é ˆæ¡ä»¶:
- ç´ æï¼ˆç®‡æ¡æ›¸ãï¼‰ã‚’ã™ã¹ã¦æœ¬æ–‡ã«è‡ªç„¶ã«å«ã‚ã‚‹ï¼ˆè¨€ã„æ›ãˆOKã ãŒè¦ç´ ã¯æ¬ ã‹ã•ãªã„ï¼‰
- èˆå°: æ™‚ä»£={era} / åœ°åŸŸ={region}
- è¦–ç‚¹: {pov_guide}
- ç‰©èªã‚¿ã‚¤ãƒ—: {story_type}
- æ„Ÿæƒ…ãƒ‘ãƒ¬ãƒƒãƒˆ: {emo_text}
- æ„Ÿæƒ…ã®æ³¢ï¼ˆèµ·ä¼ï¼‰: {wave}/10ï¼ˆé«˜ã„ã»ã©ã€Œå¬‰ã—ã„â†’åˆ‡ãªã„â†’æ•‘ã„ã€ãªã©æ„Ÿæƒ…ãŒæºã‚Œã‚‹ï¼‰
- ç››ã‚Šï¼ˆèª‡å¼µï¼‰: {ex}/10ï¼ˆé«˜ã„ã»ã©å¤§èƒ†ã«è„šè‰²ã—ã¦è‰¯ã„ï¼‰
- é›°å›²æ°—: {fantasy_style}
- ãƒˆãƒ¼ãƒ³: {tone_guide}
- 1æœ¬ã‚ãŸã‚Š: 350ã€œ900å­—
- éœ²éª¨ãªå·®åˆ¥/æ†æ‚ªè¡¨ç¾ã¯ç¦æ­¢ã€‚éåº¦ãªæ€§çš„æå†™ã¯ç¦æ­¢ã€‚

ç´ æ:
{bullet_text}

å‡ºåŠ›å½¢å¼ï¼ˆå³å®ˆï¼‰:
=== STORY 1 ===
ï¼ˆæœ¬æ–‡ï¼‰
=== STORY 2 ===
ï¼ˆæœ¬æ–‡ï¼‰
...
""".strip()

    payload = {"model": model, "prompt": prompt, "stream": False}
    r = requests.post(endpoint, json=payload, timeout=timeout_sec)
    r.raise_for_status()
    data = r.json()
    text = (data.get("response") or "").strip()

    stories = []
    chunks = re.split(r"===\s*STORY\s*\d+\s*===", text)
    for c in chunks:
        c = c.strip()
        if c:
            stories.append(c)

    if not stories and text:
        stories = [text]

    if len(stories) > num_stories:
        stories = stories[:num_stories]

    return stories

# =============================
# Streamlit App
# =============================
st.set_page_config(page_title="Fantasy Story Atelier", page_icon="ğŸ“š", layout="centered")
st.markdown(FANTASY_CSS, unsafe_allow_html=True)

st.markdown(
    """
<div class="fantasy-banner">
  <div style="font-size:1.8rem; font-weight:800;">Fantasy Story Atelier</div>
  <div class="fantasy-sub">ç®‡æ¡æ›¸ãã®â€œç´ æâ€ã‹ã‚‰ã€æ„Ÿæƒ…ã®æ³¢ã‚’ã¾ã¨ã£ãŸç‰©èªã‚’ç´¡ãã‚¢ãƒˆãƒªã‚¨</div>
  <div>
    <span class="small-pill">ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼</span>
    <span class="small-pill">ã‚ªãƒˆãƒ¡ãƒ†ã‚£ãƒƒã‚¯</span>
    <span class="small-pill">æ„Ÿæƒ…ãƒ‘ãƒ¬ãƒƒãƒˆ</span>
    <span class="small-pill">èˆå°ãƒ©ãƒ³ãƒ€ãƒ </span>
  </div>
</div>
""",
    unsafe_allow_html=True,
)

with st.sidebar:
    st.subheader("ç”Ÿæˆè¨­å®š")

    tone = st.selectbox("ãƒˆãƒ¼ãƒ³", ["ã»ã®ã¼ã®", "ã‚·ãƒªã‚¢ã‚¹", "ã‚³ãƒ¡ãƒ‡ã‚£"], index=0)
    story_type = st.selectbox("ç‰©èªã‚¿ã‚¤ãƒ—", ["æ‹", "å†’é™º", "æ—¥å¸¸", "å–ªå¤±", "å†ç”Ÿ", "å‡ºä¼šã„ã¨åˆ¥ã‚Œ"], index=0)

    exaggeration = st.slider("ç››ã‚Šï¼ˆèª‡å¼µï¼‰", 0, 10, 5)
    emotional_wave = st.slider("æ„Ÿæƒ…ã®æ³¢ï¼ˆèµ·ä¼ï¼‰", 0, 10, 7)

    emotions_all = ["æ¥½ã—ã„", "å¬‰ã—ã„", "åˆ‡ãªã„", "æ‚²ã—ã„", "æ€–ã„", "å®‰å¿ƒ", "æ†§ã‚Œ", "æ€’ã‚Š", "æ‡ã‹ã—ã„", "å­¤ç‹¬", "æ•‘ã„"]
    emotional_palette = st.multiselect(
        "æ„Ÿæƒ…ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆé¸ã¶ã»ã©æ··ã–ã‚‹ï¼‰",
        emotions_all,
        default=["å¬‰ã—ã„", "åˆ‡ãªã„", "æ•‘ã„"]
    )

    num_stories = st.slider("ç”Ÿæˆæœ¬æ•°", 1, 5, 3)

    st.markdown("---")
    st.subheader("èˆå°ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã‚‚å¯ï¼‰")
    era_options = ["ãƒ©ãƒ³ãƒ€ãƒ ", "å¤ä»£", "ä¸­ä¸–", "è¿‘ä¸–", "è¿‘ä»£", "ç¾ä»£", "æœªæ¥", "ç•°ä¸–ç•Œ"]
    region_options = ["ãƒ©ãƒ³ãƒ€ãƒ ", "ç‹éƒ½", "æ¸¯ç”º", "æ£®ã®å›½", "ç ‚æ¼ ã®éƒ½", "é›ªã®è¾ºå¢ƒ", "ç©ºä¸­éƒ½å¸‚", "åœ°ä¸‹è¿·å®®", "å­¦åœ’", "å°ã•ãªæ‘"]
    pov_options = ["ãƒ©ãƒ³ãƒ€ãƒ ", "ä¸€äººç§°ï¼ˆæ€§åˆ¥ä¸å•ï¼‰", "ä¸‰äººç§°ï¼ˆæ€§åˆ¥ä¸å•ï¼‰", "äºŒäººç§°ï¼ˆã‚ãªãŸï¼‰"]

    era_choice = st.selectbox("æ™‚ä»£", era_options, index=0)
    region_choice = st.selectbox("åœ°åŸŸ", region_options, index=0)
    pov_choice = st.selectbox("è¦–ç‚¹", pov_options, index=0)

    st.markdown("---")
    st.subheader("ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³")
    engine = st.selectbox("ã‚¨ãƒ³ã‚¸ãƒ³", ["è‡ªå‹•ï¼ˆOllamaå„ªå…ˆï¼‰", "ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆLLMãªã—ï¼‰", "Ollamaï¼ˆãƒ­ãƒ¼ã‚«ãƒ«LLMï¼‰"], index=0)

    st.subheader("Ollamaè¨­å®šï¼ˆä»»æ„ï¼‰")
    ollama_model = st.text_input("model", value=os.getenv("OLLAMA_MODEL", "llama3.1"))
    ollama_endpoint = st.text_input("endpoint", value=os.getenv("OLLAMA_ENDPOINT", "http://localhost:11434/api/generate"))

st.write("### ç´ æï¼ˆç®‡æ¡æ›¸ãï¼‰ã‚’å…¥åŠ›")
raw = st.text_area(
    "ä¾‹: æœ / ã‚³ãƒ¼ãƒ’ãƒ¼ / äºŒåº¦å¯ï¼ˆæ”¹è¡Œã§ã‚‚ã‚«ãƒ³ãƒã§ã‚‚OKï¼‰",
    height=130,
    placeholder="æœ\nã‚³ãƒ¼ãƒ’ãƒ¼\näºŒåº¦å¯\né§…ã®ãƒ›ãƒ¼ãƒ \nå°é›¨",
)

bullets = parse_bullets(raw)
if bullets:
    st.write("èª­ã¿å–ã£ãŸç´ æ:", " / ".join(bullets))
else:
    st.info("ç´ æãŒç©ºã‚„ã¨ã€ç‰©èªã®éª¨ãŒç«‹ãŸã‚“ã€‚3ã¤ãã‚‰ã„å…¥ã‚Œã‚ˆã€‚")

def should_use_ollama(engine_choice: str) -> bool:
    if engine_choice == "Ollamaï¼ˆãƒ­ãƒ¼ã‚«ãƒ«LLMï¼‰":
        return True
    if engine_choice == "ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆLLMãªã—ï¼‰":
        return False
    return True  # auto

generate = st.button("ç‰©èªã‚’ç´¡ã", type="primary", use_container_width=True)

if generate:
    if len(bullets) == 0:
        st.error("ç´ æãŒç©ºã€‚ã—ã‚ƒãƒ¼ãªã„ãªã€ã¾ãšã¯3ã¤å…¥ã‚Œã¦ã€‚")
        st.stop()

    # Resolve stage settings
    era = pick_or_custom(era_choice, era_options[1:])     # exclude "ãƒ©ãƒ³ãƒ€ãƒ "
    region = pick_or_custom(region_choice, region_options[1:])
    pov = pick_or_custom(pov_choice, pov_options[1:])

    use_ollama = should_use_ollama(engine)
    stories: list[str] = []
    used_mode = "ãƒ†ãƒ³ãƒ—ãƒ¬"

    if use_ollama:
        try:
            stories = generate_story_ollama(
                bullets=bullets,
                exaggeration=exaggeration,
                tone=tone,
                emotional_palette=emotional_palette,
                emotional_wave=emotional_wave,
                era=era,
                region=region,
                pov=pov,
                story_type=story_type,
                num_stories=num_stories,
                model=ollama_model,
                endpoint=ollama_endpoint,
            )
            if stories:
                used_mode = "Ollama"
        except Exception:
            used_mode = "ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆOllamaå¤±æ•—ã§è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰"
            stories = []

    if not stories:
        for _ in range(num_stories):
            stories.append(
                generate_story_template(
                    bullets=bullets,
                    exaggeration=exaggeration,
                    tone=tone,
                    emotional_palette=emotional_palette,
                    emotional_wave=emotional_wave,
                    era=era,
                    region=region,
                    pov=pov,
                    story_type=story_type,
                    seed=random.randint(0, 10_000_000),
                )
            )

    st.write("### ç”Ÿæˆçµæœ")
    st.caption(f"èˆå°: {era} / {region}   è¦–ç‚¹: {pov}   ã‚¿ã‚¤ãƒ—: {story_type}   ã‚¨ãƒ³ã‚¸ãƒ³: {used_mode}")

    for i, s in enumerate(stories, start=1):
        with st.expander(f"STORY {i}", expanded=(i == 1)):
            st.write(s)

    st.markdown("---")
    st.write("### ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ")
    export_text = "\n\n".join([f"=== STORY {i} ===\n{t}" for i, t in enumerate(stories, start=1)])
    st.download_button(
        label="TXTã§ä¿å­˜",
        data=export_text.encode("utf-8"),
        file_name="stories.txt",
        mime="text/plain",
        use_container_width=True
    )